---
variant: fcos
version: 1.5.0

ignition:
  config:
    merge:
      - local: ./share/mdns.butane.yml
      - local: ./share/users.butane.yml

boot_device:
  mirror:
    devices:
      ## Pin root volumes to dedicated SSDs
      - /dev/disk/by-id/ata-Samsung_SSD_850_120GB_S3WBNF0K110279P
      - /dev/disk/by-id/ata-Samsung_SSD_850_120GB_S3WBNF0K110292A

storage:
  filesystems:
    ## Mount LVM volumes
    - device: /dev/pool/var
      path: /var
      format: ext4
      wipe_filesystem: false
      with_mount_unit: true

  files:
    ## Set static hostname
    - path: /etc/hostname
      contents:
        inline: tombstone.local

    - path: /etc/containerd/config.toml
      contents:
          inline: |
            version = 2
            
            [plugins]
              [plugins."io.containerd.internal.v1.opt"]
                path = "/var/lib/containerd/opt"

              [plugins."io.containerd.snapshotter.v1.devmapper"]
                root_path = "/var/lib/containerd/io.containerd.snapshotter.v1.devmapper"
                pool_name = "pond-containerd"
                base_image_size = "8192MB"
                discard_blocks = true
                fs_type = "ext4"

systemd:
  units:
    ## Ensure that the devmapper snapshotter's thin-pool device is available
    - name: containerd.service
      enabled: true
      dropins:
        - name: after-devmapper.conf
          contents: |
            [Unit]
            Wants=dev-mapper-pond\\x2dcontainerd.device
            After=dev-mapper-pond\\x2dcontainerd.device
